<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<style>
			.small-text {
				font-size: large;
				line-height: normal;
			}
			.tiny-text {
				font-size: small;
				line-height: normal;
			}
		</style>

		<title>CSCS Spack Course 2024</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/white.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
		<link rel="stylesheet" href="plugin/asciinema/asciinema-player.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<img src="dist/images/logo.svg" />
					<h1 class="r-fit-text">CSCS Spack Course 2024</h1>
					<p>13.06.2024</p>
				</section>
				<section>
					<section>
						<img src="dist/images/logo.svg" />
						<h1 class="r-fit-text">What's new in Spack?</h1>
						<p>and what's to come?</p>
					</section>
					<section>
						<h2>What's new</h2>
						<ul>
							<li>Compiler runtime packages</li>
							<li>Automatic libc external</li>
							<li>Python virtual environments</li>
						</ul>
					</section>
					<section>
						<h2>Compiler runtime packages</h2>
						<pre><code data-trim data-noescape>
							$ spack spec zlib
							Input spec
							--------------------------------
							 -   zlib

							Concretized
							--------------------------------
							 -   zlib@1.3.1 %gcc@13.2.0 ...
							 -       ^gcc-runtime@13.2.0 %gcc@13.2.0 ...
							[e]      ^glibc@2.38 %gcc@13.2.0 ...
							 -       ^gmake@4.4.1 %gcc@13.2.0 ...
						</code></pre>
					</section>
					<section>
						<h2>What is <code>^gcc-runtime</code>?</h2>
						<ul>
							<li>A Spack installed package that copies
								<ul>
									<li><code>libstdc++.so.6</code></li>
									<li><code>libgfortran.so.5</code></li>
									<li><code>libgcc_s.so.1</code></li>
									<li>and others</li>
								</ul>
							</li>
						</ul>
					</section>
					<section>
						<h2>What is <code>^libc</code></h2>
						<ul>
							<li>An external-only package</li>
							<li>Virtual provided by <code>glibc</code> and <code>musl</code></li>
							<li>Largely replaces the static <code>os</code> tag
								<ul>
									<li class="fragment semi-fade-out"><code>os=ubuntu24.04</code></li>
									<li class="fragment fade-up"><code>^glibc@2.39</code></li>
								</ul>
							</li>
						</ul>
					</section>
					<section>
						<h2>But why?</h2>
						<ul>
							<li>Software does not break if compiler is uninstalled</li>
							<li>Install from <strong>build cache</strong> without compilers</li>
							<li>Share binaries <strong>across Linux distros</strong></li>
							<li>Create small OCI container images</li>
							<li>Be able to express<pre>
									<code class="spec" data-trim data-noescape>
									depends_on("glibc@2.31:")
									</code>
								</pre></li>
						</ul>
					</section>
					<section>
						<h2>Can't Spack build <code>glibc</code>?</h2>
						<ul>
							<li>üëç Spack would be isolated from the system
								<ul>
									<li>Better build reproducibility</li>
								</ul>
							</li>
						</ul>
						<p>but...</p>
						<ul>
							<li>üëé Spack would be isolated from the system
								<ul>
									<li>Complicates use of system compilers</li>
									<li>Complicates use of externals</li>
								</ul>
							</li>
						</ul>
						<p>currently a non-goal</p>
					</section>
					<section>
						<h2>Why not <code>^glibc-runtime</code></h2>
						<ul>
							<li>... and copy <code>libc.so.6</code>, <code>libm.so.6</code></li>
							<li>Issue is mostly with hard-coded (search) paths to and in the dynamic loader</li>
						</ul>
					</section>
					<section>
						<h2>So here we are in Spack 0.22</h2>
						<pre><code data-trim data-noescape>
							$ spack spec zlib
							Input spec
							--------------------------------
							 -   zlib

							Concretized
							--------------------------------
							 -   zlib@1.3.1 %gcc@13.2.0 ...
							 -       ^gcc-runtime@13.2.0 %gcc@13.2.0 ...
							[e]      ^glibc@2.38 %gcc@13.2.0 ...
							 -       ^gmake@4.4.1 %gcc@13.2.0 ...
						</code></pre>
					</section>
					<section>
						<h2>Spack 0.22</h2>
						<p>Compiler mixing support with <code>gcc-runtime</code></p>
						<img src="dist/images/gcc-runtime-mixing.svg" class="stretch" />
					</section>
					<section>
						<h2>Spack 0.22</h2>
						<p>Compiler is still a node attribute</p>
						<img class="stretch" src="dist/images/gcc-runtime-now.svg" />
					</section>
					<section>
						<h2>Spack 0.23 üîÆ</h2>
						<p>Compiler becomes an ordinary node itself</p>
						<img src="dist/images/gcc-runtime-future.svg" class="stretch" />
					</section>
					<section>
						<h2>Spack 0.23 üîÆ</h2>
						<p>Express dependencies of compilers</p>
						<div class="r-stack stretch">
							<pre class="fragment current-visible"><code data-trim data-noescape>
								$ clang -v
								Ubuntu clang version 16.0.6 (15)
								Target: x86_64-pc-linux-gnu
								Thread model: posix
								InstalledDir: /usr/bin
								Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/10
								Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/11
								Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/12
								Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/13
								Selected GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/13

								$ $(clang -print-prog-name=as) --version | head -n1
								GNU assembler (GNU Binutils for Ubuntu) 2.41
							</code></pre>
							<img src="dist/images/clang-runtime.svg"  class="fragment" />
						</div>
					</section>
					<section>
						<h2>Spack 0.23 üîÆ</h2>
						<ul>
							<li>Packages can <strong>inject</strong> a runtime dependency into dependents</li>
							<li>Runtimes will provide <strong>languages</strong> (partially in 0.22):
								<pre><code class="python">depends_on("fortran")</code></pre>
							</li>
							<li>No compiler for data / pure Python packages</li>
							<li>Runtimes for other things than compilers?</li>
						</ul>
					</section>
					<section>
						<h2>What is <code>python-venv</code>?</h2>
						Python's injected runtime
						<pre><code data-noescape class="spec">$ spack spec py-click
 -   py-click@8.1.7
 -       ^python@3.11.9
 -           ^ ...
 -       ^python-venv@1.0</code></pre>
					</section>
					<section>
						<h2>Why <code>python-venv</code>?</h2>
						<ul>
							<li>The least worst solution‚Ñ¢ for <strong>build isolation</strong></li>
							<li>Spack environment views = Python venvs</li>
							<li>Support external Python better</li>
						</ul>
					</section>
					<section>
						<h3>Pip and Spack are different</h3>
						<ul>
							<li><code>pip install</code>: all packages in a single venv dir
							<pre>
								<code class="bash" data-trim data-noescape>
									$ ls my_venv/lib/python3.12/site-packages
									black click isort
								</code>
							</pre></li>
							<li><code>spack install</code>: all packages in a unique dir
							<pre>
								<code class="bash" data-trim data-noescape>
									$ tree spack/opt/spack
									‚îú‚îÄ‚îÄ python-3.12.1-eu5igwm
									‚îÇ   ‚îî‚îÄ‚îÄ lib/python3.12  # standard library
									‚îú‚îÄ‚îÄ py-black-24.3.0-c5yefsp
									‚îÇ   ‚îî‚îÄ‚îÄ lib/python3.12/site-packages/black
									‚îú‚îÄ‚îÄ py-click-8.1.7-253ikya
									‚îÇ   ‚îî‚îÄ‚îÄ lib/python3.12/site-packages/click
									‚îî‚îÄ‚îÄ py-isort-5.12.0-yupkr4p
									    ‚îî‚îÄ‚îÄ lib/python3.12/site-packages/isort
								</code>
							</pre></li>
						</ul>
					</section>
					<section>
						<h3>Pip and Spack are different</h3>
						<ul>
							<li>You <code>pip install</code> packages <strong>into a venv</strong></li>
							<li>You <code>spack install</code> packages <strong>into the store</strong></li>
							<li class="fragment">A Spack environment can be "installed", but no files are put "in the environment"</li>
							<li class="fragment">Spack <strong>environment views</strong> make them look similar</li>
						</ul>
					</section>
					<section>
						<h2>Environment views</h2>
						<pre>
							<code class="shell" data-trim data-noescape>
								$ spack env create --with-view ./view .
								$ spack -e . add py-black py-isort
								$ spack -e . install
								$ ./view/bin/python3 -c 'import black'  # works
							</code>
						</pre>
					</section>
					<section data-transition="fade-out">
						<h2>Environment views</h2>
						<p>Single, flattened dir with tons of symlinks</p>
						<img src="dist/images/create-view.svg" class="stretch">
					</section>
					<section data-transition="fade-in">
						<h2>environment views</h2>
						<p style="font-size: 0.7em">with python-venv: <code style="color: rgb(145, 0, 0)">bin/activate</code> and <code style="color: rgb(145, 0, 0)">pyvenv.cfg</code></p>
						<img src="dist/images/create-view-venv.svg" class="stretch">
					</section>
					<section>
						<h2>What was the point again?</h2>
						<ul>
							<li>You can <code>source bin/activate</code></li>
							<li>Editor support (completion etc)</li>
							<li><code>pip list</code> and <code>pip install</code> interop</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>Hands-on #1</h2>
						<ul>
							<li>Learn about build caches</li>
							<li>Create container images</li>
							<li>GitHub Actions and Packages</li>
						</ul>
					</section>
					<section>
						<h2>Follow along</h2>
						<ul>
							<li><a href="https://spack-tutorial.rtfd.io" target="_blank">https://spack-tutorial.rtfd.io</a></li>
							<li>Click <strong>Binary Caches Tutorial</strong></li>
						</ul>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/1.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/2.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<h2>Setup GitHub API token</h2>
						<a href="https://github.com/settings/tokens/new">https://github.com/settings/tokens/new</a>
					</section>
					<section data-background="dist/images/github-token.png"></section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/3.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<h2>Make GitHub Package public</h2>
						<a href="https://github.com/users/haampie/packages/container/cscs-tutorial/settings">https://github.com/users/haampie/packages/container/cscs-tutorial/settings</a>
						<img src="dist/images/github-public.png" class="stretch" />
					</section>
					<section>
						<h2>Try out the build cache</h2>
						<ul>
							<li><code>spack install</code> should use it</li>
							<li>No GitHub token should be required if public</li>
						</ul>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/4.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<h2>Reuse concretization</h2>
						<ul>
							<li>The concretizer needs a build cache index</li>
							<li>It's a "remote" database</li>
							<li>Concretizer warns if not available</li>
						</ul>
					</section>
					<section>
						<h2>Reuse concretization</h2>
						<ul>
							<li>Create index with <pre><code class="shell">$ spack buildcache update-index &lt;name&gt;</code></pre></li>
							<li>Slow reduction operation</li>
							<li>Fetch all individual specs, upload single database</li>
						</ul>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/5.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<h2>Runnable container images</h2>
						<ul>
							<li>We can <code>spack install</code> from the cache</li>
							<li>We can't yet <code>docker run</code> them</li>
							<li class="fragment">Remember external <code>^glibc</code>?</li>
						</ul>
					</section>
					<section>
						<h2>Add a base image of choice</h2>
						<pre><code class="text" data-trim data-noescape>
						$ spack -e . buildcache push \
							--force \
							--base-image ubuntu:24.04
							# --base-image fedora:latest
						</code></pre>
						<ul>
							<li>Works if base image glibc is &ge; ^glibc in Spack's DAG</li>
							<li>Gives you a basic shell</li>
							<li>And yet another system package manager</li>
						</ul>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/6.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/7.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<h2>What's an OCI registry again?</h2>
						<div class="r-stack">
							<ul class="fragment current-visible">
								<li>Bunch of <strong>blobs</strong> and <strong>manifests</strong></li>
								<li><strong>Blobs</strong> are tarballs named by sha256</li>
								<li><strong>Manifests</strong> are tags &amp; list <strong>blobs</strong> as layers</li>
								<li>One blob for every Spack package prefix</li>
								<li>One manifest for every Spack package</li>
								<li>... with many layers: all runtime deps included</li>
							</ul>
							<img src="dist/images/oci-structure.svg" class="fragment" />
						</div>
					</section>
					<section>
						<h2>Tag an environment</h2>
						<ul>
							<li>By default: single root per container image</li>
							<li>How can we compose container images?</li>
							<li>Typically non-trivial: try and merge official CUDA and MKL container images</li>
							<li class="fragment">... trivial in Spack due to <strong>single prefix per package</strong></li>
						</ul>
					</section>
					<section>
						<h2>Tag an environment</h2>
						Works best with <code>unify:true</code>
						<pre><code class="shell" data-trim data-noescape>
							$ spack -e . add julia vim
							$ spack -e . install
							$ spack -e . buildcache push \
							    --tag julia-and-vim \
							    --base-image ubuntu:24.04 \
							    ghcr
						</code></pre>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/8.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<div class="asciicast stretch">
							<!--
							{
							"URL": "dist/recordings/9.cast"
							} 
							-->
						</div>
					</section>
					<section>
						<h2>In summary</h2>
						<ul>
							<li><strong><code>spack install</code></strong> the same binaries you <strong><code>docker run</code></strong></li>
							<li>Share binaries with users (un)familiar with Spack</li>
							<li>Swap in your favorite distro as a base</li>
							<li>Compose images from multiple Spack packages</li>
						</ul>
					</section>
					<section>
						<h2>Try it yourself</h2>
						<ol>
							<li>Create a GitHub repo</li>
							<li>Add a <strong><code>spack.yaml</code></strong> environment with some spec</li>
							<li>Add <strong><code>.github/workflows/ci.yaml</code></strong></li>
							<li>Use the <strong><code>spack/setup-spack</code></strong> action</li>
							<li>Add a concretize step</li>
							<li>Add an install step</li>
							<li>Add a step that pushes to your GitHub packages using <code>${{ secrets.GITHUB_TOKEN }}</code></li>
							<li>Verify that a second run uses the cache</li>
						</ol>
					</section>
				</section>

				<!-- Concretizer -->
				<section>
					<section>
						<h2>Why is the concretizer necessary?</h2>
					</section>
					<section>
						Installations can be finely tuned with the <em>spec syntax</em>
						<pre><code data-trim data-noescape class="spec">
						  # Specify a version range with `@`
						  hdf5@1.10.1

						  # Specify a compiler toolchain with `%`
						  hdf5@1.10.1 %gcc@4.7.3

						  # Activate or deactivate boolean variants
						  hdf5@1.10.1 +szip ~fortran

						  # Set multi-valued variants, or reserved keywords
						  hdf5@1.10.1 build_type=Release target=x86_64_v4
					</code></pre>
					</section>
					<section>
						Each recipe can build a software in multiple ways
						<pre><code class="python" data-trim>
							class Hdf5(CMakePackage):
								"""HDF5 is a data model, library, ... """

								homepage = "https://portal.hdfgroup.org"
								url      = "https://.../hdf5-1.14.3.tar.gz"

								version("1.14.2", sha256="4b4b4453251")
								version("1.12.3", sha256="49d88f4494a")

								variant("shared", default=True, description="...")
								variant("mpi",    default=True, description="...")

								depends_on("mpi", when="+mpi")
						</code></pre>
					</section>
					<section>
						That's not alike other functional package managers...
						<pre><code class="scheme" data-trim>
(define-public hello
  (package
	(name "hello")
	(version "2.10")
	(source
	  (origin
		(method url-fetch)
		(uri (string-append "hello-" version ".tar.gz"))
		(sha256 (base32 "0ssi1..."))))
	(build-system gnu-build-system)
	(synopsis "Hello, GNU world: An example GNU package")
	(description "GNU Hello prints ...")
	(home-page "https://www.gnu.org/software/hello/")
	(license gpl3+)))
						</code></pre>
					</section>
					<section>
						... and must solve a SAT problem to get a configuration
						<div>
							<img class="r-stretch" src="dist/images/concretizer.svg" style="background: none; border: 0px">
						</div>
					</section>
					<section>
						Using the concretizer allows trying different configurations much more easily
					</section>
					<section>
						<h2>Hands-on</h2>
						<pre><code class="bash" data-trim>
							# Try different variants, see how dependencies change
							spack spec hfd5 ...

							# Use spack graph to get more insight on DAG structure
							# To visualize: https://dreampuf.github.io/GraphvizOnline/
							spack graph -d --color ...

							# Use a temporary environment to avoid reconcretizing
							spack env activate --temp
							spack add ...
							spack concretize
							...
						</code></pre>
					</section>
				</section>
				<section>
					<section>
						<h2>Why is the concretizer so slow?</h2>
					</section>
					<section>
						Dependency resolution is NP-hard!
					</section>
					<section>
						Spack uses <em>clingo</em> and ASP to concretize
					</section>
					<section>
						A crash course in the ASP language
						<pre><code data-trim data-noescape data-line-numbers="1-3|5-7|9-10|12-16|18-23" class="prolog">
							% Facts are specific "true" statements
							node("lammps").
							variant_set("laamps", "cuda", "false").

							% Rules can derive additional facts
							path(A, B) :- depends_on(A, B).
							path(A, C) :- path(A, B), depends_on(B, C).

							% Constraints say what cannot happen
							:- path(A, B), path(B, A).

							% Choice rules gives the solver freedom to choose
							% from possible options
							1 { version(Package, V)
									: possible_version(Package, V) } 1
								:- node(Package).

							% Minimization defines the "optimal" solution
							#minimize{
								Weight,Package
								: version_weight(Package, Weight),
								  node(Package)
							}.
						</code></pre>
					</section>
					<section>
						How does clingo solve the ASP problem?
						<div>
							<img  src="dist/images/asp-grounding.svg" style="background: none; border: 0px">
						</div>
					</section>
					<section>
						Where is time spent, then?
						<pre><code data-trim data-noescape data-line-numbers="1|2,8|3,8|4,9|5,9|6,8-9" class="console">
							$ spack solve --timers hdf5
							setup          6.676s
							load           0.979s
							ground         3.700s
							solve          7.666s
							total         19.897s
							[ ... ]
							lib/spack/spack/solver/asp.py
							lib/spack/spack/solver/concretize.lp
						</code></pre>
					</section>
					<section>
						<h2>Hands-on</h2>
						<pre><code class="bash" data-trim>
							# Try to time different concretizations
							spack solve --timers ...
						</code></pre>
					</section>
				</section>
				<section>
					<section>
						<h2>How does reuse work?</h2>
					</section>
					<section>
						Concretization without reuse: <code>--fresh</code>
						<div>
							<img class="r-stretch" src="dist/images/hash-cache.svg" style="background: none; border: 0px">
						</div>
					</section>
					<section>
						Spack can also actively try to reuse
						<pre><code data-trim data-noescape class="yaml">
							concretizer:
								# Whether to consider installed packages or packages 
								# from buildcaches when concretizing specs. If `true`, 
								# we'll try to use as many installs/binaries as possible,
								# rather than building. If `false`, we'll always give you 
								# a fresh concretization. If `dependencies`, we'll only 
								# reuse dependencies but give you a fresh concretization 
								# for your root specs.
								reuse: true
						</code></pre>
					</section>
					<section>
						<pre><code data-trim data-noescape class="console">
							spack solve --show=asp hdf5
						</code></pre>
						<pre><code data-trim data-noescape class="small-text prolog">
							installed_hash("diffutils","cguhjk").
							imposed_constraint("cguhjk","node","diffutils").
							imposed_constraint("cguhjk","version","diffutils","3.10").
							imposed_constraint("cguhjk","node_platform","diffutils","linux").
							imposed_constraint("cguhjk","node_os","diffutils","ubuntu20.04").
							imposed_constraint("cguhjk","node_target","diffutils","icelake").
							imposed_constraint("cguhjk","variant_value","diffutils","build_system","autotools").
							imposed_constraint("cguhjk","node_compiler","diffutils","gcc").
							imposed_constraint("cguhjk","node_compiler_version","diffutils","gcc","9.4.0").
							imposed_constraint("cguhjk","package_hash","diffutils","kbm...").
							imposed_constraint("cguhjk","hash","diffutils","cguhjk").
							imposed_constraint("cguhjk","compatible_libc","diffutils","glibc","2.31").
							imposed_constraint("cguhjk","depends_on","diffutils","libiconv","link").
							imposed_constraint("cguhjk","virtual_on_edge","diffutils","libiconv","iconv").
							imposed_constraint("cguhjk","virtual_node","iconv").
							imposed_constraint("cguhjk","hash","libiconv","iel...").
						</code></pre>
					</section>
					<section>
						Spack v0.22 allows a <em>fine-tuned</em> selection
					</section>
					<section>
						Reuse only specs compiled with GCC
						<pre><code data-trim data-noescape class="yaml">
							concretizer:
								reuse:
									roots: true
									include:
									- "%gcc"
						</code></pre>
					</section>
					<section>
						Use OpenMPI from externals
						<pre><code data-trim data-noescape class="yaml">
							concretizer:
								reuse:
									roots: true
									from:
									# OpenMPI should not be reused 
									# from store or buildcache...
									- type: local
									  exclude: ["openmpi"]
									- type: buildcache
									  exclude: ["openmpi"]
									# ...and it must be the only external used
									- type: external
									  include: ["openmpi"]
						</code></pre>
					</section>
					<section>
						https://cache.spack.io/
						<div>
							<img height="40%" src="dist/images/build-cache.png" style="background: none; border: 0px">
						</div>
					</section>
					<section>
						<h2>Hands-on</h2>
						<pre><code data-trim data-noescape class="bash">
							# Check that using --fresh doesn't emit hash facts
							spack solve --fresh --show=asp ... | less
							
							# Add a mirror, retry
							spack mirror add developer-tools https://binaries.spack.io/develop/developer-tools-manylinux2014
							spack buildcache keys --install --trust
							spack solve --reuse --show=asp ... | less

							# Now, use a finer selection from configuration
							# https://spack.readthedocs.io/en/latest/build_settings.html#reuse-already-installed-packages
							# Check how reused specs are added according to your filters
						</code></pre>
					</section>
				</section>
				<section>
					<section>
						<h2>What is an optimal solution?</h2>
					</section>
					<section>						
						Many optimization criteria for an optimal spec
						<ul class="small-text">
							<li>Prefer newer versions</li>
							<li>Prefer default values for variants</li>
							<li>Prefer to use the same compiler across a DAG</li>
							<li>...</li>
						</ul>
					</section>
					<section>
						A lower penalty on higher priority criteria is preferred
						<pre><code data-trim data-noescape class="prolog">
							% Choose most recent versions (priority 25)
							#minimize{
								Weight@25,node(Package)
								: version_weight(node(Package), Weight)
							}.

							% Use default values for variants (priority 20)
							#minimize{
								1@20,Package,Variant,Value
								: variant_default_not_used(Package, Variant, Value)
							}.
						</code></pre>						
					</section>
					<section>
						<img class="r-stretch" src="dist/images/sums.svg" style="background: none; border: 0px">
					</section>
					<section>

						<code data-trim data-noescape class="console">
							spack solve hdf5
						</code>
						<pre><code data-trim data-noescape class="console small-text">
							Priority  Criterion                                            Installed  ToBuild
							1         requirement weight                                           -        0
							2         number of packages to build (vs. reuse)                      -        5
							3         number of nodes from the same package                        -        0
							4         deprecated versions used                                     0        0
							5         version badness (roots)                                      0        0
							6         number of non-default variants (roots)                       0        0
							7         preferred providers for roots                                0        0
							8         default values of variants not being used (roots)            0        0
							9         number of non-default variants (non-roots)                  11        0
							10        preferred providers (non-roots)                              0        0
							11        compiler mismatches that are not from CLI                   23        0
							12        compiler mismatches that are not from CLI                    0        0
							13        non-preferred OS's                                          33        0
							14        version badness (non roots)                                329        0
							15        default values of variants not being used (non-roots)        2        0
							16        non-preferred compilers                                     64        0
							17        target mismatches                                            8        0
							18        non-preferred targets                                      288        0
							19        compiler mismatches (runtimes)                               4        0
							20        version badness (runtimes)                                   0        0
							21        non-preferred targets (runtimes)                             9        0
							22        edge wiring                                                588        0
						</code></pre>
					</section>
					<section>
						<h2>Hands-on</h2>
						<pre><code class="bash" data-trim>
							# Check how weights are changing depending on the spec
							# and the overall configuration.
							spack solve --reuse ...
							spack solve --fresh ...
						</code></pre>
					</section>
				</section>
				<section>
					<section>	
						<h2>How are errors modeled?</h2>
					</section>
					<section>
						<code>clingo</code> is not that helpful on unsat problems
						<pre><code data-trim data-noescape data-line-numbers="1-4|4" class="prolog">
							node("a").

							attribute(P) :- node(P).
							:- attribute(P).
						</code></pre>
						<pre><code data-trim data-noescape class="console">
							$ clingo example.lp 
							clingo version 5.6.2
							Reading from example.lp
							Solving...
							UNSATISFIABLE
						</code></pre>
						<pre><code data-trim data-noescape class="console">
							$ spack spec foo
							==> Error: UNSATISFIABLE
						</code></pre>
					</section>
					<section>
						Make errors part of a valid solution
						<pre><code data-trim data-noescape data-line-numbers="1-4|4" class="prolog">
							node("a").

							attribute(P) :- node(P).
							error("{P} cannot have an attribute!", P) :- attribute(P).
						</code></pre>
						<pre><code data-trim data-noescape class="console">
							$ clingo example.lp 
							clingo version 5.6.2
							Reading from example.lp
							Solving...
							Answer: 1
							node("a") attribute("a") error("{P} cannot have an attribute!","a")
							SATISFIABLE
						</code></pre>
						<pre><code data-trim data-noescape class="console">
							$ spack spec foo
							==> Error: foo cannot have an attribute!
						</code></pre>
					</section>
					<section>
						Highest priority optimization is <em>minimize errors</em>
					</section>
					<section>						
						<div>
							<img src="dist/images/error-flow-chart.svg" style="background: none; border: 0px">
						</div>
					</section>
					<section>
						<pre><code data-trim data-noescape class="console tiny-text">
							$ spack spec hdf5@1.14 ^cmake@3.16
							==> Error: concretization failed for the following reasons:

							1. Cannot select a single "version" for package "cmake"
							2. Cannot satisfy 'cmake@:3.17'
							3. Cannot satisfy 'cmake@:3.16'
							4. Cannot satisfy 'cmake@3.18:'
							5. Cannot satisfy 'cmake@3.16'
							6. Cannot satisfy 'cmake@3.18:'
									required because hdf5 depends on cmake@3.18: when @1.13: 
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
							7. Cannot satisfy 'cmake@3.16'
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
							8. Cannot satisfy 'cmake@3.18:' and 'cmake@3.16
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
									required because hdf5 depends on cmake@3.18: when @1.13: 
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
							9. Cannot satisfy 'cmake@3.16' and 'cmake@3.18:
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
									required because hdf5 depends on cmake@3.18: when @1.13: 
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
							10. Cannot satisfy 'cmake@3.12:' and 'cmake@3.16
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
									required because hdf5 depends on cmake@3.12: 
									required because hdf5@1.14 ^cmake@3.16 requested explicitly 
						</code></pre>
					</section>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/anything/plugin.js"></script>
		<script src="plugin/asciinema/asciinema-player.min.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			VERSION = "=?[a-zA-Z0-9_][a-zA-Z_0-9\\-\\.]*\\b"
			VERSION_RANGE = `(${VERSION})?:(${VERSION}(?!\\s*=))?`
			VERSION_LIST = `(${VERSION_RANGE}|${VERSION})(\\s*,\\s*(${VERSION_RANGE}|${VERSION}))*`
			VERSION_SPECIFIER = `@\\s*(${VERSION_LIST})`
			NAME = "[a-zA-Z_0-9][a-zA-Z_0-9\\-.]*"
			PACKAGE = `\\^?${NAME}`
			BOOL_VARIANT = `(~|~~|\\+|\\+\\+|-|--)\\s*${NAME}`
			COMPILER = `%\\s*${NAME}\\s*(${VERSION_SPECIFIER})?`
			VALUE = "([a-zA-Z_0-9\\-+\\*.,:=\\~\\/\\\\]+)"
			QUOTED_VALUE = `('([^']|(?<=\\\\)')*'|\\"([^\\"]|(?<=\\\\)\\")*\\")`
			ARCH = `(arch|target|os|platform)=${VALUE}`
			KEY_VALUE_PAIR = `${NAME}=(${VALUE}|${QUOTED_VALUE})`
			COMMAND_LINE = `^\\$.+(\\$)*$`
			Reveal.initialize({
				highlight: {
					beforeHighlight: (hljs) => hljs.registerLanguage("spec", function() {
						return {
							case_insensitive: true,
							contains: [
								hljs.COMMENT(
									'#.+$',
								),
								{
									className: "spec-command-line",
									begin: '^\\s*\\$',
									end: '(?<!\\\\)$'  // allow newlines with \ at the end
								},
								{
									className: 'spec-arch',
									begin: ARCH
								},
								{
									className: 'spec-variant',
									begin: KEY_VALUE_PAIR
								},
								{
									className: 'spec-package',
									begin: PACKAGE
								},
								{
									className: 'spec-version',
									begin: VERSION_SPECIFIER
								},
								{
									className: 'spec-variant',
									begin: BOOL_VARIANT
								},
								{
									className: 'spec-compiler',
									begin: COMPILER
								},
								{
									className: 'spec-status-installed',
									begin: `^\\s*\\[[+e]\\]`
								},
								{
									className: 'spec-status-uninstalled',
									begin: `^\\s* - `
								}
							]
						}
					})
				},
				hash: true,
				anything: [
					{
						className: "asciicast",
						defaults: { theme: 'monokai', fontSize: '15px' },
						initialize: (function(container, options) {
							AsciinemaPlayer.create(options.URL, container, options);
						})
					},
				],
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealAnything ],
			});
		</script>
	</body>
</html>
