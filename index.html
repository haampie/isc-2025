<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>CSCS Spack Course 2024</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/white.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<section>
						<img src="dist/images/logo.svg" />
						<h1 class="r-fit-text">What's new in Spack?</h1>
						<p>and what's to come?</p>
					</section>
					<section>
						<h2>What's new</h2>
						<ul>
							<li>Compiler runtime packages</li>
							<li>Automatic libc external</li>
							<li>Python virtual environments</li>
						</ul>
					</section>
					<section>
						<h2>Compiler runtime packages</h2>
						<pre><code data-trim data-noescape>
							$ spack spec zlib
							Input spec
							--------------------------------
							 -   zlib

							Concretized
							--------------------------------
							 -   zlib@1.3.1 %gcc@13.2.0 ...
							 -       ^gcc-runtime@13.2.0 %gcc@13.2.0 ...
							[e]      ^glibc@2.38 %gcc@13.2.0 ...
							 -       ^gmake@4.4.1 %gcc@13.2.0 ...
						</code></pre>
					</section>
					<section>
						<h2>What is <code>^gcc-runtime</code>?</h2>
						<ul>
							<li>A Spack installed package that copies
								<ul>
									<li><code>libstdc++.so.6</code></li>
									<li><code>libgfortran.so.5</code></li>
									<li><code>libgcc_s.so.1</code></li>
									<li>and others</li>
								</ul>
							</li>
						</ul>
					</section>
					<section>
						<h2>What is <code>^libc</code></h2>
						<ul>
							<li>An external-only package</li>
							<li>Virtual provided by <code>glibc</code> and <code>musl</code></li>
							<li>Largely replaces the static <code>os</code> tag
								<ul>
									<li class="fragment semi-fade-out"><code>os=ubuntu24.04</code></li>
									<li class="fragment fade-up"><code>^glibc@2.39</code></li>
								</ul>
							</li>
						</ul>
					</section>
					<section>
						<h2>But why?</h2>
						<ul>
							<li>Software does not break if compiler is uninstalled</li>
							<li>Install from <strong>build cache</strong> without compilers</li>
							<li>Share binaries <strong>across Linux distros</strong></li>
							<li>Create small OCI container images</li>
							<li>Be able to express<pre>
									<code class="spec" data-trim data-noescape>
									depends_on("glibc@2.31:")
									</code>
								</pre></li>
						</ul>
					</section>
					<section>
						<h2>Can't Spack build <code>glibc</code>?</h2>
						<ul>
							<li>üëç Spack would be isolated from the system
								<ul>
									<li>Better build reproducibility</li>
								</ul>
							</li>
						</ul>
						<p>but...</p>
						<ul>
							<li>üëé Spack would be isolated from the system
								<ul>
									<li>Complicates use of system compilers</li>
									<li>Complicates use of externals</li>
								</ul>
							</li>
						</ul>
						<p>currently a non-goal</p>
					</section>
					<section>
						<h2>Why not <code>^glibc-runtime</code></h2>
						<ul>
							<li>... and copy <code>libc.so.6</code>, <code>libm.so.6</code></li>
							<li>Issue is mostly with hard-coded (search) paths to and in the dynamic loader</li>
						</ul>
					</section>
					<section>
						<h2>So here we are in Spack 0.22</h2>
						<pre><code data-trim data-noescape>
							$ spack spec zlib
							Input spec
							--------------------------------
							 -   zlib

							Concretized
							--------------------------------
							 -   zlib@1.3.1 %gcc@13.2.0 ...
							 -       ^gcc-runtime@13.2.0 %gcc@13.2.0 ...
							[e]      ^glibc@2.38 %gcc@13.2.0 ...
							 -       ^gmake@4.4.1 %gcc@13.2.0 ...
						</code></pre>
					</section>
					<section>
						<h2>Spack 0.22</h2>
						<p>Compiler mixing support with <code>gcc-runtime</code></p>
						<img src="dist/images/gcc-runtime-mixing.svg" class="stretch" />
					</section>
					<section>
						<h2>Spack 0.22</h2>
						<p>Compiler is still a node attribute</p>
						<img class="stretch" src="dist/images/gcc-runtime-now.svg" />
					</section>
					<section>
						<h2>Spack 0.23 üîÆ</h2>
						<p>Compiler becomes an ordinary node itself</p>
						<img src="dist/images/gcc-runtime-future.svg" class="stretch" />
					</section>
					<section>
						<h2>Spack 0.23 üîÆ</h2>
						<p>Express dependencies of compilers</p>
						<img src="dist/images/clang-runtime.svg"  class="stretch" />
					</section>
					<section>
						<h2>Spack 0.23 üîÆ</h2>
						<ul>
							<li>Packages can <strong>inject</strong> a runtime dependency into dependents</li>
							<li>Runtimes will provide <strong>languages</strong> (partially in 0.22):
								<pre><code class="python">depends_on("fortran")</code></pre>
							</li>
							<li>No compiler for data / pure Python packages</li>
							<li>Runtimes for other things than compilers?</li>
						</ul>
					</section>
					<section>
						<h2>What is <code>python-venv</code>?</h2>
						Python's injected runtime
						<pre><code data-noescape class="spec">$ spack spec py-click
 -   py-click@8.1.7
 -       ^python@3.11.9
 -           ^ ...
 -       ^python-venv@1.0</code></pre>
					</section>
					<section>
						<h2>Why <code>python-venv</code>?</h2>
						<ul>
							<li>The least worst solution‚Ñ¢ for <strong>build isolation</strong></li>
							<li>Spack environment views = Python venvs</li>
							<li>Support external Python better</li>
						</ul>
					</section>
					<section>
						<h3>Pip and Spack are different</h3>
						<ul>
							<li><code>pip install</code>: all packages in a single venv dir
							<pre>
								<code class="bash" data-trim data-noescape>
									$ ls my_venv/lib/python3.12/site-packages
									black click isort
								</code>
							</pre></li>
							<li><code>spack install</code>: all packages in a unique dir
							<pre>
								<code class="bash" data-trim data-noescape>
									$ tree spack/opt/spack
									‚îú‚îÄ‚îÄ python-3.12.1-eu5igwm
									‚îÇ   ‚îî‚îÄ‚îÄ lib/python3.12  # standard library
									‚îú‚îÄ‚îÄ py-black-24.3.0-c5yefsp
									‚îÇ   ‚îî‚îÄ‚îÄ lib/python3.12/site-packages/black
									‚îú‚îÄ‚îÄ py-click-8.1.7-253ikya
									‚îÇ   ‚îî‚îÄ‚îÄ lib/python3.12/site-packages/click
									‚îî‚îÄ‚îÄ py-isort-5.12.0-yupkr4p
									    ‚îî‚îÄ‚îÄ lib/python3.12/site-packages/isort
								</code>
							</pre></li>
						</ul>
					</section>
					<section>
						<h3>Pip and Spack are different</h3>
						<ul>
							<li>You <code>pip install</code> packages <strong>into a venv</strong></li>
							<li>You <code>spack install</code> packages <strong>into the store</strong></li>
							<li class="fragment">A Spack environment can be "installed", but no files are put "in the environment"</li>
							<li class="fragment">Spack <strong>environment views</strong> make them look similar</li>
						</ul>
					</section>
					<section>
						<h2>Environment views</h2>
						<pre>
							<code class="shell" data-trim data-noescape>
								$ spack env create --with-view ./view .
								$ spack -e . add py-black py-isort
								$ spack -e . install
								$ ./view/bin/python3 -c 'import black'  # works
							</code>
						</pre>
					</section>
					<section data-transition="fade-out">
						<h2>Environment views</h2>
						<p>Single, flattened dir with tons of symlinks</p>
						<img src="dist/images/create-view.svg" class="stretch">
					</section>
					<section data-transition="fade-in">
						<h2>environment views</h2>
						<p style="font-size: 0.7em">with python-venv: <code style="color: rgb(145, 0, 0)">bin/activate</code> and <code style="color: rgb(145, 0, 0)">pyvenv.cfg</code></p>
						<img src="dist/images/create-view-venv.svg" class="stretch">
					</section>
					<section>
						<h2>What was the point again?</h2>
						<ul>
							<li>You can <code>source bin/activate</code></li>
							<li>Editor support (completion etc)</li>
							<li><code>pip list</code> and <code>pip install</code> interop</li>
						</ul>
					</section>
				</section>

				<!-- Concretizer -->
				<section>
					<section>
						<h2>Why is the concretizer necessary?</h2>
					</section>
					<section>
						Installations can be finely tuned with the <em>spec syntax</em>
						<pre><code data-trim data-noescape class="spec">
						  # Specify a version range with `@`
						  hdf5@1.10.1

						  # Specify a compiler toolchain with `%`
						  hdf5@1.10.1 %gcc@4.7.3

						  # Activate or deactivate boolean variants
						  hdf5@1.10.1 +szip ~fortran

						  # Set multi-valued variants, or reserved keywords
						  hdf5@1.10.1 build_type=Release target=x86_64_v4
					</code></pre>
					</section>
					<section>
						Each recipe builds a software under <em>different scenarios</em>
						<pre><code class="python" data-trim>
							class Hdf5(CMakePackage):
								"""HDF5 is a data model, library, ... """

								homepage = "https://portal.hdfgroup.org"
								url      = "https://.../hdf5-1.14.3.tar.gz"

								version("1.14.2", sha256="4b4b4453251")
								version("1.12.3", sha256="49d88f4494a")

								variant("shared", default=True, description="...")
								variant("mpi",    default=True, description="...")

								depends_on("mpi", when="+mpi")
						</code></pre>
					</section>
					<section>
						That's not alike other functional package managers...
						<pre><code class="scheme" data-trim>
(define-public hello
  (package
	(name "hello")
	(version "2.10")
	(source
	  (origin
		(method url-fetch)
		(uri (string-append "hello-" version ".tar.gz"))
		(sha256 (base32 "0ssi1..."))))
	(build-system gnu-build-system)
	(synopsis "Hello, GNU world: An example GNU package")
	(description "GNU Hello prints ...")
	(home-page "https://www.gnu.org/software/hello/")
	(license gpl3+)))
						</code></pre>
					</section>
					<section>
						... and must solve a SAT problem to get a configuration
						<div>
							<img class="r-stretch" src="dist/images/concretizer.svg" style="background: none; border: 0px">
						</div>
					</section>
					<section>
						Using the concretizer allows trying different configurations much more easily
					</section>
				</section>
				<section>
					<section>
						<h2>Why is the concretizer so slow?</h2>
					</section>
					<section>
						Dependency resolution is NP-hard!
					</section>
					<section>
						Spack uses <em>clingo</em> and ASP to concretize
					</section>
					<section>
						A crash course in the ASP language
						<pre><code data-trim data-noescape data-line-numbers="1-3|5-7|9-10|12-16|18-23" class="prolog">
							% Facts are specific "true" statements
							node("lammps").
							variant_set("laamps", "cuda", "false").

							% Rules can derive additional facts
							path(A, B) :- depends_on(A, B).
							path(A, C) :- path(A, B), depends_on(B, C).

							% Constraints say what cannot happen
							:- path(A, B), path(B, A).

							% Choice rules gives the solver freedom to choose
							% from possible options
							1 { version(Package, V)
									: possible_version(Package, V) } 1
								:- node(Package).

							% Minimization defines the "optimal" solution
							#minimize{
								Weight,Package
								: version_weight(Package, Weight),
								  node(Package)
							}.
						</code></pre>
					</section>
					<section>
						How does clingo solve the ASP problem?
						<div>
							<img  src="dist/images/asp-grounding.svg" style="background: none; border: 0px">
						</div>
					</section>
					<section>
						Where is time spent, then?
						<pre><code data-trim data-noescape data-line-numbers="1|2,8|3,8|4,9|5,9|6,8-9" class="console">
							$ spack solve --timers hdf5
							setup          6.676s
							load           0.979s
							ground         3.700s
							solve          7.666s
							total         19.897s
							[ ... ]
							lib/spack/spack/solver/asp.py
							lib/spack/spack/solver/concretize.lp
						</code></pre>
					</section>
				</section>
				<section>
					<section>
						<h2>What is an "optimal" solution?</h2>
					</section>
					<section>
						Many minimization criteria with different priorities
						<pre><code data-trim data-noescape class="prolog">
							% Choose most recent versions (priority 25)
							#minimize{
								Weight@25,node(Package)
								: version_weight(node(Package), Weight)
							}.

							% Use default values for variants (priority 20)
							#minimize{
								1@20,Package,Variant,Value
								: variant_default_not_used(Package, Variant, Value)
							}.
						</code></pre>
						A lower penalty on higher priority criteria is preferred
					</section>
					<section>
						<img class="r-stretch" src="dist/images/sums.svg" style="background: none; border: 0px">
					</section>
					<section>
						Check concretization weights
						<img width="50%" src="dist/images/solve-weights.png" style="background: none; border: 0px">
					</section>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			VERSION = "=?[a-zA-Z0-9_][a-zA-Z_0-9\\-\\.]*\\b"
			VERSION_RANGE = `(${VERSION})?:(${VERSION}(?!\\s*=))?`
			VERSION_LIST = `(${VERSION_RANGE}|${VERSION})(\\s*,\\s*(${VERSION_RANGE}|${VERSION}))*`
			VERSION_SPECIFIER = `@\\s*(${VERSION_LIST})`
			NAME = "[a-zA-Z_0-9][a-zA-Z_0-9\\-.]*"
			PACKAGE = `\\^?${NAME}`
			BOOL_VARIANT = `(~|~~|\\+|\\+\\+|-|--)\\s*${NAME}`
			COMPILER = `%\\s*${NAME}\\s*(${VERSION_SPECIFIER})?`
			VALUE = "([a-zA-Z_0-9\\-+\\*.,:=\\~\\/\\\\]+)"
			QUOTED_VALUE = `('([^']|(?<=\\\\)')*'|\\"([^\\"]|(?<=\\\\)\\")*\\")`
			ARCH = `(arch|target|os|platform)=${VALUE}`
			KEY_VALUE_PAIR = `${NAME}=(${VALUE}|${QUOTED_VALUE})`
			COMMAND_LINE = `^\\$.+(\\$)*$`
			Reveal.initialize({
				highlight: {
					beforeHighlight: (hljs) => hljs.registerLanguage("spec", function() {
						return {
							case_insensitive: true,
							contains: [
								{
									className: "spec-command-line",
									begin: '^\\s*\\$',
									end: '(?<!\\\\)$'  // allow newlines with \ at the end
								},
								{
									className: 'spec-arch',
									begin: ARCH
								},
								{
									className: 'spec-variant',
									begin: KEY_VALUE_PAIR
								},
								{
									className: 'spec-package',
									begin: PACKAGE
								},
								{
									className: 'spec-version',
									begin: VERSION_SPECIFIER
								},
								{
									className: 'spec-variant',
									begin: BOOL_VARIANT
								},
								{
									className: 'spec-compiler',
									begin: COMPILER
								},
								{
									className: 'spec-status-installed',
									begin: `^\\s*\\[[+e]\\]`
								},
								{
									className: 'spec-status-uninstalled',
									begin: `^\\s* - `
								}
							]
						}
					})
				},
				hash: true,
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ],
			});
		</script>
	</body>
</html>
